import time
import os

from telegram import Bot, InlineKeyboardMarkup, InlineKeyboardButton
from sqlalchemy.orm import Session

from models import get_user_by_telegram_id, create_user, update_user_thread_id, increment_message_count, User
from database import SessionLocal
from referral import generate_cabinet_message

from admin_commands import handle_admin_stats, handle_admin_referrals, give_unlimited_access

from openai_api import reset_user_thread, send_message_to_assistant
from ui import main_menu, subscription_plan_keyboard
from utils import clean_markdown
from filters import classify_crisis_level, log_crisis_message
from datetime import datetime

ADMIN_IDS = ["944583273", "396497806"]
FREE_MESSAGES_LIMIT = int(os.environ.get("FREE_MESSAGES_LIMIT", 50))

bot = Bot(token=os.environ["TELEGRAM_TOKEN"])


async def handle_update(update, db):
    message = update.get("message")
    print("‚öô handle_update —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:", message.get("text", ""))
    if not message:
        return

    text = message.get("text", "")
    chat_id = message["chat"]["id"]
    telegram_id = str(message["from"]["id"])

    # ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
    ref_code = None
    if text.startswith("/start"):
        parts = text.strip().split(" ", 1)
        ref_code = parts[1].strip() if len(parts) > 1 else None

        if ref_code and ref_code.startswith("ref"):
            ref_code = ref_code.replace("ref", "", 1)
        if ref_code and not ref_code.isdigit():
            ref_code = None

    user = get_user_by_telegram_id(db, telegram_id)
    if not user:
        print(f"üÜï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {telegram_id}")
        user = create_user(db, telegram_id, referrer_code=ref_code)

    if text.startswith("/"):
        handle_command(text, user, chat_id, bot, db)
    else:
        try:
            handle_menu_button(text, user, chat_id, bot, db)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_menu_button: {e}")
            import traceback
            traceback.print_exc()


async def handle_command(text: str, user: User, chat_id: int, bot: Bot, db: Session):
    if text.startswith("/start"):
        parts = text.strip().split(" ", 1)
        ref_code = parts[1].strip() if len(parts) > 1 else None

        if ref_code and ref_code.startswith("ref"):
            ref_code = ref_code.replace("ref", "", 1)
        if ref_code and not ref_code.isdigit():
            ref_code = None

        if not user:
            user = create_user(db, str(chat_id), referrer_code=ref_code)
            print(f"[üë§] –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –ø–æ —Ä–µ—Ñ. –∫–æ–¥—É: {ref_code}")
        elif not user.referrer_code and ref_code:
            user.referrer_code = ref_code
            db.commit()
            print(f"[üîÅ] –†–µ—Ñ. –∫–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {ref_code}")

        await bot.send_message(
            chat_id,
            "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n"
            "–ü—Ä–∏–≤–µ—Ç, —è –ò–ª–∞ ‚Äî —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–æ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—é.\n\n"
            "üÜì –í–∞–º –¥–æ—Å—Ç—É–ø–Ω–æ 50 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.\n"
            "üí≥ –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ª–∏–º–∏—Ç–∞ –º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.\n\n"
            "üìã –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –º–µ–Ω—é –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.",
            reply_markup=main_menu()
        )
        return

    if text == "/admin_stats" and str(user.telegram_id) in ADMIN_IDS:
        handle_admin_stats(db, chat_id, bot)
        return

    if text == "/admin_referrals" and str(user.telegram_id) in ADMIN_IDS:
        handle_admin_referrals(db, chat_id, bot)
        return

    if text.startswith("/give_unlimited") and str(user.telegram_id) in ADMIN_IDS:
        give_unlimited_access(db, bot, chat_id, text)
        return


async def handle_menu_button(text: str, user: User, chat_id: int, bot: Bot, db: Session):
    telegram_id = user.telegram_id

    if text == "üí≥ –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É":
        await bot.send_message(
            chat_id,
            "üí° _–° –ò–ª–∞ AI –ë–æ—Ç —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –∫–∞–∫ –æ—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞._\n\n"
            "üîπ *1 –º–µ—Å—è—Ü*: 1 199 ‚ÇΩ ‚Äî –Ω–∞—á–Ω–∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤\n"
            "üîπ *1 –≥–æ–¥*: 11 999 ‚ÇΩ ‚Äî –≤—ã–≥–æ–¥–Ω–æ, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –æ–ø–æ—Ä—É\n\n"
            "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∏–∂–µ:",
            reply_markup=subscription_plan_keyboard(),
            parse_mode="Markdown"
        )
        return

    if text in ["üóì –ö—É–ø–∏—Ç—å –Ω–∞ 1 –º–µ—Å—è—Ü", "üìÖ –ö—É–ø–∏—Ç—å –Ω–∞ 1 –≥–æ–¥"]:
        plan = "monthly" if text == "üóì –ö—É–ø–∏—Ç—å –Ω–∞ 1 –º–µ—Å—è—Ü" else "yearly"
        invoice_id = int(time.time())
        await bot.send_message(
            chat_id,
            "üîó –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ:",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üí≥ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ", url=payment_url)]
            ])
        )
        return

    if text in ["üìú –£—Å–ª–æ–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", "‚ùì –ì–∏–¥ –ø–æ –±–æ—Ç—É"]:
        filename = {
            "‚ùì –ì–∏–¥ –ø–æ –±–æ—Ç—É": "guide.txt",
            "üìú –£—Å–ª–æ–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è": "rules.txt"
        }.get(text)
        try:
            with open(f"texts/{filename}", "r", encoding="utf-8") as f:
                response = f.read()
        except FileNotFoundError:
            response = "–§–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω."
        await bot.send_message(chat_id, response, reply_markup=main_menu())
        return

    if text == "üîÑ –°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥":
        reset_user_thread(db, user)
        await bot.send_message(
            chat_id,
            "üîÅ –î–∏–∞–ª–æ–≥ —Å–±—Ä–æ—à–µ–Ω. –¢—ã –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä, –∏ —è –±—É–¥—É –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤—Å—ë —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.",
            reply_markup=main_menu()
        )
        return

    if text == "üîô –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await bot.send_message(chat_id, "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu())
        return

    if text in ["üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", "üë• –ö–∞–±–∏–Ω–µ—Ç", "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"]:
        message_text, markup = generate_cabinet_message(user, telegram_id, db)
        await bot.send_message(chat_id, message_text, reply_markup=markup)
        return

    elif text == "ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞":
        try:
            with open("texts/partner.txt", "r", encoding="utf-8") as file:
                partner_info = file.read()
            await bot.send_message(chat_id, partner_info, reply_markup=main_menu())
        except Exception as e:
            print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ partner.txt:", e)
            await bot.send_message(chat_id, "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ.", reply_markup=main_menu())
        return



    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —É—á—ë—Ç–æ–º –ø–æ–¥–ø–∏—Å–∫–∏
    if not user.is_unlimited:
        if user.has_paid:
            if user.subscription_expires_at and user.subscription_expires_at < datetime.utcnow():
                user.has_paid = False
                db.commit()
                await bot.send_message(
                    chat_id,
                    "üì≠ –°—Ä–æ–∫ –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç—ë–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ñ–æ—Ä–º–∏—Ç–µ –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É.",
                    reply_markup=main_menu()
                )
                return
        else:
            if user.free_messages_used >= FREE_MESSAGES_LIMIT:
                await bot.send_message(
                    chat_id,
                    "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.\n–û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.",
                    reply_markup=main_menu()
                )
                return


    crisis_level = classify_crisis_level(text)
    if crisis_level in ["high", "medium", "low"]:
        log_crisis_message(telegram_id, text, level=crisis_level)
        if crisis_level == "high":
            await bot.send_message(chat_id, (
                "–ú–Ω–µ –æ—á–µ–Ω—å –∂–∞–ª—å, —á—Ç–æ —Ç—ã —Å–µ–π—á–∞—Å –∏—Å–ø—ã—Ç—ã–≤–∞–µ—à—å —Ç–∞–∫–∏–µ —Ç—è–∂—ë–ª—ã–µ —á—É–≤—Å—Ç–≤–∞.\n\n"
                "–ï—Å–ª–∏ —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ –∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –º—ã—Å–ª–∏ –Ω–∞–≤—Ä–µ–¥–∏—Ç—å —Å–µ–±–µ ‚Äî –≤–∞–∂–Ω–æ –Ω–µ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è —Å —ç—Ç–∏–º –Ω–∞–µ–¥–∏–Ω–µ. "
                "–û–±—Ä–∞—Ç–∏—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –∏–ª–∏ –∫—Ä–∏–∑–∏—Å–Ω–æ–π —Å–ª—É–∂–±–µ. üíô\n\n"
                "–Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ. –¢—ã –Ω–µ –æ–¥–∏–Ω(–æ–¥–Ω–∞)."
            ))
            return

    try:
        assistant_response, thread_id = send_message_to_assistant(user.thread_id, text)
    except Exception as e:
        print('‚ùå –û—à–∏–±–∫–∞ –≤ GPT:', e)
        if "run is active" in str(e):
            user.thread_id = None
            db.commit()
            assistant_response, thread_id = send_message_to_assistant(None, text)
        else:
            raise e

    if not user.thread_id:
        update_user_thread_id(db, user, thread_id)

    increment_message_count(db, user)
    assistant_response = clean_markdown(assistant_response)
    await bot.send_message(chat_id, assistant_response, reply_markup=main_menu())
