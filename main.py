from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse
import traceback
from aiogram.types import Update
import aiogram

from bot_instance import bot, dp
from handlers import gptchat, menu_handlers, aiogram_handlers, admin_handlers_aiogram
from cloudpayments import verify_signature  # üîπ –¥–æ–±–∞–≤–ª–µ–Ω–æ

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ —Ä–æ—É—Ç–µ—Ä—ã
dp.include_routers(
    gptchat.router,
    menu_handlers.router,
    aiogram_handlers.router
)

app = FastAPI()

print("üí° AIOGRAM VERSION:", aiogram.__version__)


@app.get("/")
async def root():
    return {"status": "ok"}

@app.post("/webhook")
async def telegram_webhook(request: Request):
    try:
        data = await request.json()
        print("üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Telegram:")
        print(data)

        update = Update(**data)
        await dp.feed_update(bot, update)
        return {"ok": True}
    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ –≤ telegram_webhook:", e)
        traceback.print_exc()
        return JSONResponse(status_code=500, content={"error": str(e)})

# üîπ –ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ CloudPayments —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
@app.post("/payment/cloudpayments/result")
async def cloudpayments_result(request: Request):
    body = await request.body()
    signature = request.headers.get("Content-HMAC")

    if not signature or not verify_signature(body, signature):
        return JSONResponse(content={"code": 13, "message": "Invalid signature"}, status_code=400)

    # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ
    return JSONResponse(content={"code": 0})
